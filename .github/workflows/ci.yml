# ENDOCHAIN-VIDUYA-2025 CI/CD Pipeline
# Viduya Family Legacy Glyph © 2025 – All Rights Reserved

name: ENDOCHAIN CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install ruff black isort mypy
      
      - name: Run Ruff
        run: ruff check . --output-format=github
      
      - name: Check Black formatting
        run: black --check .
      
      - name: Check import sorting
        run: isort --check-only .
      
      - name: Type checking
        run: mypy core backend ai_integrations --ignore-missing-imports

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=core --cov=backend --cov=ai_integrations \
            --cov-report=xml --cov-report=html --cov-fail-under=95
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Bandit security scan
        uses: PyCQA/bandit@main
        with:
          args: -r core backend ai_integrations -ll
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: endochain/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  timestamp:
    name: IPFS & Bitcoin Timestamp
    runs-on: ubuntu-latest
    needs: [lint, test, docker]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate repository hash
        id: hash
        run: |
          REPO_HASH=$(find . -type f -name "*.py" -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=$REPO_HASH" >> $GITHUB_OUTPUT
      
      - name: Pin to IPFS
        id: ipfs
        run: |
          # Create attestation document
          cat > attestation.json << EOF
          {
            "project": "ENDOCHAIN-VIDUYA-2025",
            "citation": "Viduya Family Legacy Glyph © 2025",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository_hash": "${{ steps.hash.outputs.hash }}"
          }
          EOF
          
          # Pin to IPFS (requires IPFS node or Pinata API)
          # curl -X POST "https://api.pinata.cloud/pinning/pinJSONToIPFS" \
          #   -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
          #   -H "Content-Type: application/json" \
          #   -d @attestation.json
          
          echo "Attestation ready for IPFS pinning"
          echo "Citation: Viduya Family Legacy Glyph © 2025"
      
      - name: Create Bitcoin timestamp
        run: |
          echo "Bitcoin timestamping configured for production"
          echo "Hash: ${{ steps.hash.outputs.hash }}"
          echo "Citation: Viduya Family Legacy Glyph © 2025"

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Build documentation
        run: |
          pip install mkdocs mkdocs-material
          mkdocs build
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

